#!/usr/bin/env node

var yargs = require('yargs')
	.usage('Usage: check <file> [options]')
    .describe('v', 'Verbose flag. Will print statements.')
    .describe('r', 'Recrusive flag. Will recursively check required files.')
    .describe('o', 'Output flag. Will output ast into ASTOutput.js.')
    .describe('j', 'Will output <json class=""></json>')
    .showHelpOnFail(false);

var check   = require('../check.js'),
	colors  = require('colors'),
	fs = require('fs'),
	path = require('path'),
	file = process.argv[2];

if (!file) {
	yargs.showHelp();
	process.exit();
}

file = path.resolve(file);

if (!fs.existsSync(file)) {
	console.error(file, 'doesn\'t exist.');
	process.exit();
} else if (!fs.lstatSync(file).isFile()) {
	console.error(file, 'is not a file.');
	process.exit();
}

var argv = yargs.argv;

if (argv.h) {
	yargs.showHelp();
	process.exit();
}

var sinks = module.exports.sinks = require('../danger.json').sinks;
var sources = module.exports.sources = require('../danger.json').sources;

check.flags.verbose = argv.v;
check.flags.recursive = argv.r;

console.log(' ---- '.yellow, file.white);

var scope = new check.Scope({
	sources: sources, sinks: sinks,
	file: file
});

if (argv.j) {
	scope.log = function(type, node, name, value) {
		console.dir({
			type: type,
			pos: this.file + ':' + check.pos(node),
			name: name,
			value: value
		});
	};
	
	scope.createNewScope = function() {
		console.log('[');
	};

	scope.leaveScope = function() {
		console.log('],');
	};
}

var ast = check.astFromFile(scope.file, argv.o);
check.traverse(ast, scope);